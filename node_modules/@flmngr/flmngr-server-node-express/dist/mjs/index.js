import bodyParser from "body-parser";
import express from "express";
const cors = require('cors');
const busboy = require('connect-busboy');
import { ExpressRequest } from "./ExpressRequest";
import { FlmngrServer } from "@flmngr/flmngr-server-node";
export function bindFlmngr(config) {
    config.app.use(cors());
    config.app.use(busboy());
    config.app.use(config.urlFileManager, bodyParser.json());
    config.app.use(config.urlFileManager, bodyParser.urlencoded({ extended: true }));
    if (!!config.urlFiles) {
        config.app.use(config.urlFiles, express.static(config.dirFiles));
    }
    config.app.post(config.urlFileManager, (req, res) => {
        config.request = new ExpressRequest(req);
        let busboy = req.busboy;
        busboy.on('file', function (fieldname, file, filename, encoding, mimetype) {
            if (fieldname === "file") {
                req["postFile"] = {
                    "filename": filename,
                    "data": null
                };
                file.on('data', function (data) {
                    let oldData = req["postFile"]["data"];
                    let newData = oldData == null ? data : Buffer.concat([oldData, data]);
                    req["postFile"]["data"] = newData;
                });
            }
        });
        busboy.on('field', (fieldname, val, fieldnameTruncated, valTruncated, encoding, mimetype) => {
            req.body[fieldname] = val;
        });
        busboy.on('finish', () => {
            FlmngrServer.flmngrRequest(config, {
                onFinish: (httpStatusCode, headers, response) => {
                    for (const headerName in headers)
                        res.header(headerName, headers[headerName]);
                    res.statusCode = httpStatusCode;
                    if (typeof response === "string") {
                        res.send(response);
                    }
                    else if (typeof response === "object" && response.constructor.name === "ReadStream") {
                        response.pipe(res);
                    }
                    else {
                        res.json(response);
                    }
                },
                onLogError: (error) => {
                    config.onLogError || console.log(error);
                }
            }, config.overrideFramework || "express").then(r => { });
        });
        req.pipe(busboy);
    });
}
//# sourceMappingURL=index.js.map